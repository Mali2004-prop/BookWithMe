// data, i18n, flows
const SHOPS=[
{id:'s1',name:'Salon Glückssträhne',city:'Berlin',services:['haarschnitt','farbe','pflege'],lat:52.520008,lng:13.404954},
{id:'s2',name:'Cut & Coffee',city:'Hamburg',services:['haarschnitt','bart'],lat:53.551086,lng:9.993682},
{id:'s3',name:'Barber König',city:'München',services:['bart','haarschnitt'],lat:48.137154,lng:11.576124},
{id:'s4',name:'Color Studio',city:'Köln',services:['farbe','pflege'],lat:50.937531,lng:6.960279},
{id:'s5',name:'Style Atelier',city:'Frankfurt',services:['haarschnitt','farbe','pflege'],lat:50.110924,lng:8.682127},
];
const I18N={de:{searchPlaceholder:'Suche nach Shop, Stadt oder Service …',searchBtn:'Suchen',aiSupport:'KI Support',aiSubtitle:'Frag nach dem passenden Service oder einem Shop in deiner Nähe',authTitle:'Einloggen / Registrieren',email:'E-Mail',nameOptional:'Name (optional)',cancel:'Abbrechen',continue:'Weiter',aiInputPh:"Z. B. 'Ich will heute einen Haarschnitt in Berlin'…",ask:'Fragen',book:'Termin buchen',bookSub:'Datum und Service wählen, in 30 Sekunden fertig.',aiHelp:'KI Hilfe',aiHelpSub:'Unsicher? Lass dir den richtigen Service empfehlen.',invoices:'Rechnungen',invoicesSub:'Zugriff auf deine bestehenden Rechnungen.',close:'Schließen',bizTitle:'Unternehmen registrieren',bizSubtitle:'Kostenlos starten – später auf Pro upgraden. Angebote können jederzeit ergänzt werden.',bizName:'Firmenname',city:'Stadt',address:'Adresse (optional)',offers:'Angebote',addOffer:'Angebot hinzufügen',reset:'Zurücksetzen',createBiz:'Jetzt kostenlos erstellen'},en:{searchPlaceholder:'Search by shop, city or service…',searchBtn:'Search',aiSupport:'AI Support',aiSubtitle:'Ask for the right service or a shop near you',authTitle:'Sign in / Register',email:'Email',nameOptional:'Name (optional)',cancel:'Cancel',continue:'Continue',aiInputPh:"e.g. 'I want a haircut in Berlin today'…",ask:'Ask',book:'Book appointment',bookSub:'Pick date & service — done in 30 seconds.',aiHelp:'AI Help',aiHelpSub:'Not sure? Get a recommendation.',invoices:'Invoices',invoicesSub:'Access your existing invoices.',close:'Close',bizTitle:'Register your business',bizSubtitle:'Start for free — upgrade later. You can add offers anytime.',bizName:'Business name',city:'City',address:'Address (optional)',offers:'Offers',addOffer:'Add offer',reset:'Reset',createBiz:'Create for free'}};
const $=(q,el=document)=>el.querySelector(q);
function applyI18n(root=document){const lang=localStorage.getItem('bwm_lang')||'de';const d=I18N[lang]||I18N.de;root.querySelectorAll('[data-i18n]').forEach(el=>{const k=el.getAttribute('data-i18n');if(d[k]) el.textContent=d[k];});root.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{const k=el.getAttribute('data-i18n-placeholder');if(d[k]) el.setAttribute('placeholder',d[k]);});const sel=$('#langSelect',root);if(sel){sel.value=lang;}}
function initLang(){const sel=$('#langSelect');if(!sel) return;sel.addEventListener('change',()=>{localStorage.setItem('bwm_lang',sel.value);applyI18n(document);});applyI18n(document);}
function initCommon(){const yEl=$('#year');if(yEl) yEl.textContent=(new Date()).getFullYear();initLang();const authBtn=$('#authBtn');const authModal=$('#authModal');if(authBtn&&authModal){authBtn.addEventListener('click',()=>authModal.showModal());authModal.addEventListener('close',()=>{if(authModal.returnValue!=='cancel'){const mail=$('#authEmail',authModal).value.trim();const name=$('#authName',authModal).value.trim();if(mail) localStorage.setItem('bwm_user',JSON.stringify({mail,name}));}});}}
function initHome(){const mapEl=$('#map');if(!mapEl) return;const map=L.map('map',{zoomControl:true}).setView([51.163361,10.447683],6);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);const markers=new Map();SHOPS.forEach(s=>{const m=L.marker([s.lat,s.lng]).addTo(map).bindPopup(`<strong>${s.name}</strong><br>${s.city}`);m.on('click',()=>window.location.href=`shop.html?id=${s.id}`);markers.set(s.id,m);});const form=$('#searchForm');const input=$('#searchInput');const results=$('#searchResults');function match(q){q=q.toLowerCase().trim();if(!q) return [];return SHOPS.filter(s=>s.name.toLowerCase().includes(q)||s.city.toLowerCase().includes(q)||s.services.some(v=>v.includes(q))).slice(0,6);}function render(list){results.innerHTML='';if(!list.length){results.classList.remove('show');return;}list.forEach(s=>{const li=document.createElement('li');li.innerHTML=`<strong>${s.name}</strong> <span class="muted">• ${s.city}</span>`;li.addEventListener('click',()=>window.location.href=`shop.html?id=${s.id}`);results.appendChild(li);});results.classList.add('show');}input.addEventListener('input',()=>render(match(input.value)));form.addEventListener('submit',e=>{e.preventDefault();const list=match(input.value);if(list[0]) window.location.href=`shop.html?id=${list[0].id}`});document.addEventListener('click',e=>{if(!results.contains(e.target)&&e.target!==input) results.classList.remove('show');});const aiModal=$('#aiModal');const aiOpen=$('#aiOpen');const aiAsk=$('#aiAsk');const aiInput=$('#aiQuestion');const aiMessages=$('#aiMessages');const d=I18N[localStorage.getItem('bwm_lang')||'de'];aiOpen?.addEventListener('click',()=>{aiModal.showModal();aiInput.focus();});function msg(t){const div=document.createElement('div');div.className='ai-msg';div.innerHTML=t;aiMessages.appendChild(div);}function handle(){const q=aiInput.value.trim();if(!q) return;msg(`<strong>Du:</strong> ${q}`);const qw=q.toLowerCase();const need=(()=>{if(qw.includes('bart')) return 'bart';if(qw.includes('farbe')||qw.includes('color')||qw.includes('highlight')) return 'farbe';if(qw.includes('pflege')) return 'pflege';return 'haarschnitt';})();const city=['berlin','hamburg','münchen','koeln','köln','frankfurt'].find(c=>qw.includes(c));let cand=SHOPS.filter(s=>s.services.includes(need));if(city){const norm=city.replace('köln','köln').replace('koeln','köln');cand=cand.filter(s=>s.city.toLowerCase().includes(norm));}if(!cand.length) cand=SHOPS;const list=cand.slice(0,3).map(s=>`<li><a href="shop.html?id=${s.id}">${s.name}</a> <span class="muted">• ${s.city}</span></li>`).join('');msg(`<strong>${d.aiSupport}:</strong> ${d.bookSub||'Empfehlung'}<ul>${list}</ul>`);aiInput.value='';aiMessages.scrollTop=aiMessages.scrollHeight;}aiAsk?.addEventListener('click',handle);aiInput?.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();handle();}});}
function initShop(){const p=new URLSearchParams(window.location.search);const id=p.get('id');const s=SHOPS.find(x=>x.id===id)||SHOPS[0];const nameEl=$('#shopName');const metaEl=$('#shopMeta');if(nameEl) nameEl.textContent=s.name;if(metaEl) metaEl.textContent=`${s.city} • Services: ${s.services.join(', ')}`;const mini=$('#miniModal');$('#bookTile')?.addEventListener('click',e=>{e.preventDefault();$('#miniTitle').textContent=I18N[localStorage.getItem('bwm_lang')||'de'].book;$('#miniBody').innerHTML=`<label>Datum</label><input type="date" style="padding:12px;border:1px solid var(--border);border-radius:12px;width:100%"><label style="margin-top:10px;display:block">Service</label><select style="padding:12px;border:1px solid var(--border);border-radius:12px;width:100%">${s.services.map(o=>`<option>${o}</option>`).join('')}</select><div style="margin-top:12px;text-align:right"><button class="btn">Weiter</button></div>`;mini.showModal();});$('#aiTile')?.addEventListener('click',()=>{$('#miniTitle').textContent=I18N[localStorage.getItem('bwm_lang')||'de'].aiHelp;$('#miniBody').innerHTML=`<p class="muted">Stell deine Frage – z. B. „Welche Dienstleistung passt zu meiner Haarlänge?“</p><div style="display:flex;gap:10px"><input style="flex:1;padding:12px;border:1px solid var(--border);border-radius:12px" placeholder="Frag die KI…"><button class="btn">Fragen</button></div>`;mini.showModal();});$('#invoiceTile')?.addEventListener('click',e=>{e.preventDefault();$('#miniTitle').textContent=I18N[localStorage.getItem('bwm_lang')||'de'].invoices;const user=JSON.parse(localStorage.getItem('bwm_user')||'{}');$('#miniBody').innerHTML=user.mail?`<p class="muted">Eingeloggt als <strong>${user.mail}</strong>. Hier würden deine Rechnungen erscheinen.</p>`:`<p class="muted">Bitte zuerst einloggen, um Rechnungen zu sehen.</p>`;mini.showModal();});}
function initBusiness(){const form=$('#bizForm');if(!form) return;const offersEl=$('#offers');const addBtn=$('#addOfferBtn');const offerName=$('#offerName');const offerPrice=$('#offerPrice');const feedback=$('#bizFeedback');const d=I18N[localStorage.getItem('bwm_lang')||'de'];function renderOffer(n,p){const div=document.createElement('div');div.className='offer-card';div.innerHTML=`<strong>${n}</strong><br><span class="muted">${p?p+' €':''}</span>`;offersEl.appendChild(div);}addBtn.addEventListener('click',()=>{const n=offerName.value.trim();const p=offerPrice.value.trim();if(!n) return;renderOffer(n,p);offerName.value='';offerPrice.value='';});form.addEventListener('submit',e=>{e.preventDefault();const payload={name:$('#bizName').value.trim(),city:$('#bizCity').value.trim(),email:$('#bizEmail').value.trim(),address:$('#bizAddress').value.trim(),offers:Array.from(offersEl.querySelectorAll('.offer-card')).map(div=>div.querySelector('strong').textContent)};localStorage.setItem('bwm_onboarding',JSON.stringify(payload));feedback.textContent=d===I18N.de?'Erstellt! Wir melden uns per E‑Mail.':'Created! We will contact you by email.';setTimeout(()=>window.location.href='index.html',1200);});}
document.addEventListener('DOMContentLoaded',()=>{const y=$('#year');if(y) y.textContent=new Date().getFullYear();initCommon();initHome();initShop();initBusiness();});